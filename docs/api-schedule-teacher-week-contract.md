# Контракт API: расписание преподавателя на неделю

Документ-контракт для фронтенда. Описан эндпоинт получения расписания занятий на неделю для текущего аутентифицированного преподавателя. Эндпоинт автоматически определяет преподавателя по JWT-токену и возвращает все его занятия за указанную неделю с полным контекстом: информация о группе, предмете, аудитории, времени, типе занятия и других преподавателях. По этому документу можно реализовать полную страницу расписания для преподавателей.

---

## 1. Общие сведения

### 1.1 Базовый URL и префиксы

| Префикс | Назначение |
|---------|-------------|
| `/api` | Общий префикс REST API |
| `/api/schedule` | Расписание: здания, аудитории, слоты времени, занятия |

Хост и порт задаются окружением развёртывания. В описании ниже указаны только путь и query.

### 1.2 Авторизация

- Запросы выполняются с **JWT-токеном в cookie** (HttpOnly cookie `accessToken`). Токен выдаётся при входе через `/api/auth/login`.
- Эндпоинт **требует аутентификации** — пользователь должен быть залогинен.
- Эндпоинт доступен только пользователям, у которых есть **профиль преподавателя** (teacher profile). Если у пользователя нет профиля преподавателя, возвращается ошибка `403 FORBIDDEN` с кодом `SCHEDULE_TEACHER_PROFILE_NOT_FOUND`.

### 1.3 Типы данных в ответах

- **UUID** — строка в формате UUID, например: `"550e8400-e29b-41d4-a716-446655440000"`.
- **Даты и время** — строки в формате **ISO-8601**: дата-время вида `"2025-02-05T12:00:00"`, дата вида `"2025-02-05"`, время вида `"09:00:00"` (всегда формат HH:mm:ss).
- **Числа** — JSON number; для целых полей (день недели) — целое число.
- **null** — явное отсутствие значения; поля могут не присутствовать в JSON или быть `null` в зависимости от контракта.

### 1.4 Формат ошибок

При любой ошибке (4xx, 5xx) сервер возвращает JSON-объект **ErrorResponse**:

| Поле | Тип | Описание |
|------|-----|----------|
| `code` | string | Код ошибки: общий (например `UNAUTHORIZED`, `FORBIDDEN`, `BAD_REQUEST`) или доменный модуля Schedule (`SCHEDULE_TEACHER_PROFILE_NOT_FOUND`) |
| `message` | string | Человекочитаемое сообщение |
| `timestamp` | string | Момент возникновения ошибки (ISO-8601, UTC) |
| `details` | object \| null | Опционально. Для ошибок валидации — объект «имя поля → сообщение»; иначе может отсутствовать |

Пример ответа с ошибкой аутентификации (401):

```json
{
  "code": "UNAUTHORIZED",
  "message": "Authentication required",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

Пример ответа с ошибкой отсутствия профиля преподавателя (403):

```json
{
  "code": "SCHEDULE_TEACHER_PROFILE_NOT_FOUND",
  "message": "User does not have a teacher profile",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

---

## 2. Получение расписания преподавателя на неделю

### 2.1 Назначение эндпоинта

Эндпоинт предназначен для получения **полного расписания занятий на неделю** для текущего аутентифицированного преподавателя. Используется для отображения страницы расписания преподавателя в интерфейсе.

**Ключевые особенности:**
- Автоматическое определение преподавателя по JWT-токену (не требуется передавать teacherId)
- Возвращает все занятия за ISO-неделю (понедельник–воскресенье), содержащую указанную дату
- Включает полный контекст каждого занятия: группа, предмет, аудитория, время, тип занятия, другие преподаватели
- Оптимизирован для производительности: batch-загрузка данных, отсутствие N+1 запросов
- Возвращает пустой список, если у преподавателя нет занятий на указанную неделю

### 2.2 Метод и путь

`GET /api/schedule/lessons/week/teacher`

### 2.3 Права доступа

- **Требуется аутентификация** (JWT-токен в cookie)
- Пользователь должен иметь **профиль преподавателя** (teacher profile)

### 2.4 Параметры

#### Query-параметры

| Параметр | Тип | Обязательность | Описание |
|----------|-----|----------------|----------|
| `date` | string (ISO-8601 date) | Обязательный | Любая дата в пределах нужной недели. Неделя определяется как ISO-неделя (понедельник–воскресенье), содержащая эту дату. Формат: `YYYY-MM-DD`, например: `2025-02-18` |

**Пример запроса:**
```
GET /api/schedule/lessons/week/teacher?date=2025-02-18
```

### 2.5 Логика работы эндпоинта

1. **Извлечение userId из токена:**
   - Эндпоинт получает JWT-токен из cookie `accessToken`
   - Из токена извлекается `userId` текущего аутентифицированного пользователя
   - Если токен отсутствует или невалиден → `401 UNAUTHORIZED`

2. **Определение teacherId:**
   - По `userId` ищется профиль преподавателя (teacher profile)
   - Если профиль не найден → `403 FORBIDDEN` с кодом `SCHEDULE_TEACHER_PROFILE_NOT_FOUND`
   - Если профиль найден, извлекается `teacherId` (UUID сущности Teacher)

3. **Поиск offerings преподавателя:**
   - Находятся все offerings (предложения занятий), где преподаватель назначен одним из способов:
     - Как основной преподаватель offering (поле `teacherId` в offering)
     - Как преподаватель слота offering (поле `teacherId` в offering slot)
     - Как преподаватель в слоте офферинга (offering_slot.teacher_id)
   - Если у преподавателя нет offerings → возвращается пустой список `[]`

4. **Поиск занятий на неделю:**
   - Определяется ISO-неделя: понедельник–воскресенье, содержащая указанную дату
   - Находятся все занятия (lessons) за эту неделю для найденных offerings
   - Занятия сортируются по дате (возрастание), затем по времени начала (возрастание)
   - Если занятий нет → возвращается пустой список `[]`

5. **Обогащение данных (enrichment):**
   - Для каждого занятия загружается полный контекст:
     - Информация об offering (id, groupId, curriculumSubjectId, teacherId)
     - Информация о слоте offering (если занятие сгенерировано из слота)
     - Список всех преподавателей offering с ролями
     - Информация об аудитории (если назначена)
     - Информация об основном преподавателе
     - Название предмета (subject name)
     - **Информация о группе** (id, code, name)
   - Все данные загружаются batch-запросами (без N+1)

6. **Формирование ответа:**
   - Возвращается список объектов `LessonForScheduleDto`, каждый содержит полный контекст занятия

### 2.6 Успешный ответ

**HTTP-статус:** `200 OK`

**Тело ответа:** массив объектов `LessonForScheduleDto` (может быть пустым массивом `[]`)

#### Структура LessonForScheduleDto

| Поле | Тип | Описание |
|------|-----|----------|
| `lesson` | object (LessonDto) | Основная информация о занятии (дата, время, статус) |
| `offering` | object (OfferingSummaryDto) \| null | Краткая информация об offering (предложении занятия) |
| `slot` | object (SlotSummaryDto) \| null | Информация о слоте offering, если занятие сгенерировано из слота |
| `teachers` | array of TeacherRoleDto | Список всех преподавателей offering с ролями (может быть пустым) |
| `room` | object (RoomSummaryDto) \| null | Информация об аудитории, если назначена |
| `mainTeacher` | object (TeacherSummaryDto) \| null | Информация об основном преподавателе |
| `subjectName` | string \| null | Название предмета |
| `group` | object (GroupSummaryDto) \| null | **Информация о группе** (id, code, name) |

#### Структура LessonDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор занятия |
| `offeringId` | UUID | Id offering (предложения занятия) |
| `offeringSlotId` | UUID \| null | Id слота offering, если занятие сгенерировано из слота |
| `date` | string (ISO-8601 date) | Дата занятия (формат: `YYYY-MM-DD`) |
| `startTime` | string | Время начала (формат: `HH:mm:ss`, например: `09:00:00`) |
| `endTime` | string | Время окончания (формат: `HH:mm:ss`, например: `10:30:00`) |
| `timeslotId` | UUID \| null | Id шаблона времени (timeslot), если использовался при создании |
| `roomId` | UUID \| null | Id аудитории, если назначена |
| `topic` | string \| null | Тема занятия (опционально) |
| `status` | string | Статус занятия: `PLANNED` (запланировано), `CANCELLED` (отменено), `DONE` (проведено) |
| `createdAt` | string (ISO-8601 datetime) | Дата и время создания записи |
| `updatedAt` | string (ISO-8601 datetime) | Дата и время последнего обновления |

#### Структура OfferingSummaryDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Id offering |
| `groupId` | UUID | Id группы, для которой создано это offering |
| `curriculumSubjectId` | UUID | Id предмета из учебного плана (curriculum subject) |
| `teacherId` | UUID \| null | Id основного преподавателя offering (может быть null) |

#### Структура SlotSummaryDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Id слота offering |
| `offeringId` | UUID | Id offering |
| `dayOfWeek` | integer | День недели (1–7, где 1 = понедельник, 7 = воскресенье) |
| `startTime` | string | Время начала слота (формат: `HH:mm:ss`) |
| `endTime` | string | Время окончания слота (формат: `HH:mm:ss`) |
| `timeslotId` | UUID \| null | Id шаблона времени, если использовался |
| `lessonType` | string | Тип занятия: `LECTURE` (лекция), `PRACTICE` (практика), `LAB` (лабораторная), `SEMINAR` (семинар) |
| `roomId` | UUID \| null | Id аудитории слота (если назначена на уровне слота) |
| `teacherId` | UUID \| null | Id преподавателя слота (если назначен на уровне слота) |
| `createdAt` | string (ISO-8601 datetime) | Дата и время создания слота |

#### Структура TeacherRoleDto

| Поле | Тип | Описание |
|------|-----|----------|
| `teacherId` | UUID | Id преподавателя (профиль teacher) |
| `role` | string | Роль преподавателя в offering: `LECTURE` (лектор), `PRACTICE` (ведущий практику), `LAB` (ведущий лабораторную) |

#### Структура RoomSummaryDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Id аудитории |
| `number` | string | Номер аудитории |
| `buildingName` | string \| null | Название здания |

#### Структура TeacherSummaryDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Id преподавателя (профиль teacher) |
| `displayName` | string | Отображаемое имя преподавателя (englishName или teacherId/personnel number) |

#### Структура GroupSummaryDto

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Id группы |
| `code` | string | Код группы (например: `"ИТ-21-1"`) |
| `name` | string \| null | Название группы (опционально) |

### 2.7 Ошибки

#### 2.7.1 401 UNAUTHORIZED

**Когда возникает:**
- Пользователь не аутентифицирован (отсутствует или невалиден JWT-токен)
- Токен истёк или имеет неверный формат

**Код ошибки:** `UNAUTHORIZED`

**Пример ответа:**
```json
{
  "code": "UNAUTHORIZED",
  "message": "Authentication required",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

**Действия фронтенда:**
- Перенаправить пользователя на страницу входа
- Очистить локальные данные аутентификации

#### 2.7.2 403 FORBIDDEN — отсутствие профиля преподавателя

**Когда возникает:**
- Пользователь аутентифицирован, но у него нет профиля преподавателя (teacher profile)
- Пользователь не является преподавателем

**Код ошибки:** `SCHEDULE_TEACHER_PROFILE_NOT_FOUND`

**Пример ответа:**
```json
{
  "code": "SCHEDULE_TEACHER_PROFILE_NOT_FOUND",
  "message": "User does not have a teacher profile",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

**Действия фронтенда:**
- Показать сообщение пользователю о том, что доступ к расписанию преподавателя недоступен
- Предложить перейти на другую страницу или связаться с администратором

#### 2.7.3 400 BAD_REQUEST — неверный формат даты

**Когда возникает:**
- Параметр `date` отсутствует или имеет неверный формат
- Дата не соответствует формату ISO-8601 (`YYYY-MM-DD`)

**Код ошибки:** `BAD_REQUEST`

**Пример ответа:**
```json
{
  "code": "BAD_REQUEST",
  "message": "Invalid date format. Expected YYYY-MM-DD",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

**Действия фронтенда:**
- Проверить формат даты перед отправкой запроса
- Показать сообщение об ошибке валидации

### 2.8 Особенности и важные замечания

1. **ISO-неделя:**
   - Неделя определяется как период с понедельника по воскресенье
   - Если указана дата среды (например, 2025-02-18), неделя будет с понедельника 2025-02-16 по воскресенье 2025-02-22
   - Все занятия за эту неделю возвращаются в одном запросе

2. **Сортировка:**
   - Занятия сортируются сначала по дате (возрастание), затем по времени начала (возрастание)
   - Это позволяет отображать занятия в хронологическом порядке

3. **Пустой список:**
   - Если у преподавателя нет занятий на указанную неделю, возвращается пустой массив `[]`
   - Это не ошибка, а нормальная ситуация

4. **Null-значения:**
   - Поля могут быть `null`, если соответствующая информация отсутствует
   - Например, `slot` будет `null` для ручных занятий (не сгенерированных из слота)
   - `room` будет `null`, если аудитория не назначена
   - `group` будет `null` только в исключительных случаях (если группа была удалена)

5. **Производительность:**
   - Эндпоинт оптимизирован для производительности
   - Используются batch-запросы для загрузки связанных данных
   - Отсутствуют N+1 запросы к базе данных

6. **Определение основного преподавателя:**
   - Основной преподаватель (`mainTeacher`) определяется приоритетно:
     1. Преподаватель слота (`slot.teacherId`), если слот существует
     2. Основной преподаватель offering (`offering.teacherId`), если слот отсутствует
   - Если ни один из них не назначен, `mainTeacher` будет `null`

7. **Информация о группе:**
   - Поле `group` содержит полную информацию о группе (id, code, name)
   - Это позволяет отображать название группы в расписании без дополнительных запросов
   - Группа определяется через `offering.groupId`

---

## 3. Примеры запросов и ответов

### 3.1 Успешный запрос с занятиями

**Запрос:**
```
GET /api/schedule/lessons/week/teacher?date=2025-02-18
```

**Ответ (200 OK):**
```json
[
  {
    "lesson": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "offeringId": "660e8400-e29b-41d4-a716-446655440001",
      "offeringSlotId": "770e8400-e29b-41d4-a716-446655440002",
      "date": "2025-02-17",
      "startTime": "09:00:00",
      "endTime": "10:30:00",
      "timeslotId": "880e8400-e29b-41d4-a716-446655440003",
      "roomId": "990e8400-e29b-41d4-a716-446655440004",
      "topic": null,
      "status": "PLANNED",
      "createdAt": "2025-01-15T10:00:00",
      "updatedAt": "2025-01-15T10:00:00"
    },
    "offering": {
      "id": "660e8400-e29b-41d4-a716-446655440001",
      "groupId": "aa0e8400-e29b-41d4-a716-446655440005",
      "curriculumSubjectId": "bb0e8400-e29b-41d4-a716-446655440006",
      "teacherId": "cc0e8400-e29b-41d4-a716-446655440007"
    },
    "slot": {
      "id": "770e8400-e29b-41d4-a716-446655440002",
      "offeringId": "660e8400-e29b-41d4-a716-446655440001",
      "dayOfWeek": 1,
      "startTime": "09:00:00",
      "endTime": "10:30:00",
      "timeslotId": "880e8400-e29b-41d4-a716-446655440003",
      "lessonType": "LECTURE",
      "roomId": "990e8400-e29b-41d4-a716-446655440004",
      "teacherId": "cc0e8400-e29b-41d4-a716-446655440007",
      "createdAt": "2025-01-10T08:00:00"
    },
    "teachers": [
      {
        "teacherId": "cc0e8400-e29b-41d4-a716-446655440007",
        "role": "LECTURE"
      },
      {
        "teacherId": "dd0e8400-e29b-41d4-a716-446655440008",
        "role": "PRACTICE"
      }
    ],
    "room": {
      "id": "990e8400-e29b-41d4-a716-446655440004",
      "number": "101",
      "buildingName": "Главный корпус"
    },
    "mainTeacher": {
      "id": "cc0e8400-e29b-41d4-a716-446655440007",
      "displayName": "John Doe"
    },
    "subjectName": "Математический анализ",
    "group": {
      "id": "aa0e8400-e29b-41d4-a716-446655440005",
      "code": "ИТ-21-1",
      "name": "Информационные технологии, группа 1"
    }
  },
  {
    "lesson": {
      "id": "550e8400-e29b-41d4-a716-446655440010",
      "offeringId": "660e8400-e29b-41d4-a716-446655440011",
      "offeringSlotId": null,
      "date": "2025-02-18",
      "startTime": "14:00:00",
      "endTime": "15:30:00",
      "timeslotId": null,
      "roomId": null,
      "topic": "Консультация по курсовой работе",
      "status": "PLANNED",
      "createdAt": "2025-02-10T12:00:00",
      "updatedAt": "2025-02-10T12:00:00"
    },
    "offering": {
      "id": "660e8400-e29b-41d4-a716-446655440011",
      "groupId": "aa0e8400-e29b-41d4-a716-446655440012",
      "curriculumSubjectId": "bb0e8400-e29b-41d4-a716-446655440013",
      "teacherId": "cc0e8400-e29b-41d4-a716-446655440007"
    },
    "slot": null,
    "teachers": [
      {
        "teacherId": "cc0e8400-e29b-41d4-a716-446655440007",
        "role": "LECTURE"
      }
    ],
    "room": null,
    "mainTeacher": {
      "id": "cc0e8400-e29b-41d4-a716-446655440007",
      "displayName": "John Doe"
    },
    "subjectName": "Базы данных",
    "group": {
      "id": "aa0e8400-e29b-41d4-a716-446655440012",
      "code": "ИТ-21-2",
      "name": "Информационные технологии, группа 2"
    }
  }
]
```

### 3.2 Успешный запрос без занятий

**Запрос:**
```
GET /api/schedule/lessons/week/teacher?date=2025-02-18
```

**Ответ (200 OK):**
```json
[]
```

### 3.3 Ошибка аутентификации

**Запрос:**
```
GET /api/schedule/lessons/week/teacher?date=2025-02-18
```
(без токена или с невалидным токеном)

**Ответ (401 UNAUTHORIZED):**
```json
{
  "code": "UNAUTHORIZED",
  "message": "Authentication required",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

### 3.4 Ошибка отсутствия профиля преподавателя

**Запрос:**
```
GET /api/schedule/lessons/week/teacher?date=2025-02-18
```
(пользователь аутентифицирован, но не является преподавателем)

**Ответ (403 FORBIDDEN):**
```json
{
  "code": "SCHEDULE_TEACHER_PROFILE_NOT_FOUND",
  "message": "User does not have a teacher profile",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

### 3.5 Ошибка неверного формата даты

**Запрос:**
```
GET /api/schedule/lessons/week/teacher?date=2025/02/18
```

**Ответ (400 BAD_REQUEST):**
```json
{
  "code": "BAD_REQUEST",
  "message": "Invalid date format. Expected YYYY-MM-DD",
  "timestamp": "2025-02-18T12:00:00.123Z",
  "details": null
}
```

---

## 4. Сводная таблица ошибок

| HTTP-код | Код ошибки | Когда возникает | Действия фронтенда |
|----------|------------|-----------------|-------------------|
| 401 | `UNAUTHORIZED` | Пользователь не аутентифицирован или токен невалиден | Перенаправить на страницу входа |
| 403 | `SCHEDULE_TEACHER_PROFILE_NOT_FOUND` | У пользователя нет профиля преподавателя | Показать сообщение о недоступности функции |
| 400 | `BAD_REQUEST` | Неверный формат параметра `date` | Показать ошибку валидации |

---

## 5. Рекомендации по реализации фронтенда

### 5.1 Структура страницы расписания

1. **Заголовок страницы:**
   - Название: "Моё расписание"
   - Отображение текущей недели (даты начала и конца недели)
   - Кнопки навигации: предыдущая/следующая неделя

2. **Выбор недели:**
   - Календарь или поле ввода даты для выбора недели
   - По умолчанию — текущая неделя
   - При изменении даты — автоматический запрос к API

3. **Отображение расписания:**
   - Таблица или календарная сетка (7 дней × временные слоты)
   - Группировка занятий по дням недели
   - Для каждого занятия отображать:
     - Время (startTime - endTime)
     - Название предмета (`subjectName`)
     - Группа (`group.code` или `group.name`)
     - Аудитория (`room.number` и `room.buildingName`, если есть)
     - Тип занятия (`slot.lessonType`, если есть)
     - Статус занятия (`lesson.status`) с визуальным индикатором
     - Тема занятия (`lesson.topic`, если есть)
     - Другие преподаватели (если есть в `teachers`)

4. **Обработка пустого списка:**
   - Если API возвращает пустой массив — показать сообщение "На этой неделе нет занятий"

5. **Обработка ошибок:**
   - 401: перенаправить на страницу входа
   - 403: показать сообщение "Доступ к расписанию преподавателя недоступен"
   - 400: показать ошибку валидации под полем выбора даты

### 5.2 Оптимизация запросов

- Кэшировать результаты запроса на клиенте (например, на 5 минут)
- Использовать debounce при изменении даты (если пользователь быстро переключает недели)
- Показывать индикатор загрузки во время запроса

### 5.3 Визуальное оформление

- Использовать цветовую кодировку для статусов:
  - `PLANNED` — синий/зелёный
  - `CANCELLED` — серый/красный
  - `DONE` — зелёный
- Выделять текущий день недели
- Использовать иконки для типов занятий (лекция, практика, лабораторная)

---

## 6. Дополнительная информация

### 6.1 Связанные эндпоинты

Для полноценной реализации страницы расписания могут понадобиться:

- `GET /api/academic/semesters/by-date?date=YYYY-MM-DD` — получение информации о семестре для указанной даты
- `GET /api/schedule/rooms` — список всех аудиторий (для фильтрации или отображения)
- `GET /api/schedule/timeslots` — список шаблонов времени (для справки)

### 6.2 Примечания по данным

- Все времена в ответах всегда в формате `HH:mm:ss` (например, `09:00:00`, а не `09:00`)
- Даты всегда в формате ISO-8601 (`YYYY-MM-DD`)
- UUID всегда в стандартном формате с дефисами
- Поля могут быть `null` — фронтенд должен корректно обрабатывать отсутствие значений

---

**Версия документа:** 1.0  
**Дата создания:** 2025-02-18  
**Последнее обновление:** 2025-02-18
