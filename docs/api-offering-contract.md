# Контракт API: офферинги и создание уроков

Документ-контракт для фронтенда по модулю **Offerings** (офферинги группы по предметам, слоты расписания, генерация уроков). Описаны смысл каждой ручки, **воркфлоу создания уроков** (что нужно сделать до генерации), структуры запросов и ответов, а также эндпоинты других модулей, необходимые для подстановки данных в поля (группы, предметы учебного плана, учителя, таймслоты, комнаты, семестры).

---

## 1. Общие сведения

### 1.1 Базовый URL и префиксы

| Префикс | Назначение |
|---------|-------------|
| `/api` | Общий префикс REST API |
| `/api/offerings` | Офферинги (группа + предмет из учебного плана), учителя офферинга, недельные слоты, генерация уроков |
| `/api/groups` | Группы (для выбора группы при создании офферинга) |
| `/api/programs` | Программы, учебные планы, предметы учебного плана (для выбора предмета) |
| `/api/account` | Учителя (для выбора преподавателя) |
| `/api/schedule` | Таймслоты, комнаты, уроки (для слотов и отображения расписания) |
| `/api/academic` | Семестры (для выбора семестра при генерации уроков) |

Хост и порт задаются окружением развёртывания.

### 1.2 Авторизация

- Запросы выполняются с заголовком **`Authorization: Bearer <JWT>`** (токен выдаётся при входе).
- Эндпоинты, которые **изменяют данные** (POST, PUT, DELETE), доступны только пользователям с одной из ролей: **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.
- Эндпоинты только для чтения (GET) доступны **любой аутентифицированной роли** (JWT обязателен).
- У каждого эндпоинта в описании указано поле **Роли:** — кто может вызывать ручку. При отсутствии прав возвращается `403 Forbidden` (код `FORBIDDEN`), при невалидном или отсутствующем JWT — `401 Unauthorized` (код `UNAUTHORIZED`).

### 1.3 Типы данных в ответах

- **UUID** — строка в формате UUID.
- **Даты и время** — строки **ISO-8601**: дата-время `"2025-02-05T12:00:00"`, дата `"2025-02-05"`, время `"09:00"` или `"09:00:00"`.
- **Числа** — JSON number; для целых (день недели, количество недель) — integer.
- **null** — явное отсутствие значения.

### 1.4 Формат ошибок

При любой ошибке (4xx, 5xx) сервер возвращает JSON-объект **ErrorResponse**:

| Поле | Тип | Описание |
|------|-----|----------|
| `code` | string | Код ошибки (например, `BAD_REQUEST`, `NOT_FOUND`, `CONFLICT`, `OFFERING_NOT_FOUND`, `OFFERING_NO_SLOTS`) |
| `message` | string | Человекочитаемое сообщение |
| `timestamp` | string | Момент возникновения ошибки (ISO-8601, UTC) |
| `details` | object \| null | Опционально. Для валидации — объект «имя поля → сообщение» |

Пример ответа с ошибкой (404):

```json
{
  "code": "OFFERING_NOT_FOUND",
  "message": "Offering not found",
  "timestamp": "2025-02-07T12:00:00.123Z",
  "details": null
}
```

---

## 2. Воркфлоу создания уроков

Чтобы **сгенерировать уроки** по офферингу (или по всей группе), администратор/модератор должен выполнить следующие шаги **до** вызова эндпоинтов генерации.

### 2.1 Что должно быть в системе заранее

- **Группа** с привязанным **учебным планом** (curriculum). Группа получается через `/api/groups`; у группы есть `curriculumId`.
- **Предметы учебного плана** (curriculum subjects) с полем **durationWeeks** (сколько недель идёт предмет: 12, 16 и т.д.). Список предметов плана — **GET /api/programs/curricula/{curriculumId}/subjects**.
- **Семестр** с датами начала и конца. Список семестров — **GET /api/academic/years/{academicYearId}/semesters** или **GET /api/academic/semesters/current**.
- **Таймслоты** (шаблоны времени: день недели + время) — для удобного выбора «когда в неделю идёт занятие». Список — **GET /api/schedule/timeslots**.
- **Комнаты** и **учителя** — для подстановки в офферинг и в слоты. Комнаты: **GET /api/schedule/rooms**; учителя: **GET /api/account/teachers**.

### 2.2 Последовательность действий

1. **Выбрать группу** (например, из списка **GET /api/groups** или **GET /api/groups/program/{programId}**).
2. **Получить предметы учебного плана группы**: по `curriculumId` группы вызвать **GET /api/programs/curricula/{curriculumId}/subjects**. Из списка выбрать предметы, по которым нужно вести занятия.
3. **Создать офферинг** для группы и предмета: **POST /api/offerings** с телом `{ "groupId", "curriculumSubjectId", "teacherId?", "roomId?", "format?", "notes?" }`. Один офферинг = одна группа + один предмет из плана. Можно создать несколько офферингов для одной группы (по разным предметам).
4. **Добавить недельные слоты** к каждому офферингу: **POST /api/offerings/{offeringId}/slots** с телом `{ "timeslotId?", "dayOfWeek?", "startTime?", "endTime?", "lessonType", "roomId?", "teacherId?" }`.  
   - Либо передать **timeslotId** (тогда день и время подставятся из таймслота).  
   - Либо передать **dayOfWeek** (1–7, понедельник=1), **startTime**, **endTime** (строки `"HH:mm"` или `"HH:mm:ss"`).  
   - **lessonType** обязательно: `LECTURE`, `PRACTICE`, `LAB`, `SEMINAR`.  
   Количество слотов определяет, **сколько уроков в неделю** по этому предмету: один слот — один урок в неделю; два слота — два урока в неделю и т.д.
5. **Сгенерировать уроки** (обязательно указать **semesterId** — уроки создаются только для одного семестра):
   - Для одного офферинга: **POST /api/offerings/{offeringId}/generate-lessons?semesterId={semesterId}**.
   - Для всех офферингов группы: **POST /api/offerings/group/{groupId}/generate-lessons?semesterId={semesterId}**.
   Количество созданных уроков = (число слотов офферинга) × **durationWeeks** предмета из учебного плана (даты уроков — только в границах выбранного семестра). Если уроки по этому офферингу для этого семестра уже есть, используйте **POST /api/offerings/{offeringId}/regenerate-lessons?semesterId={semesterId}** (удалятся только уроки в диапазоне дат этого семестра, затем создадутся заново; уроки других семестров не затрагиваются).

### 2.3 Итог

- **До генерации** нужны: группа с планом, предметы плана (с durationWeeks), **семестр** (его id передаётся в **semesterId**), офферинги, у каждого офферинга — хотя бы один слот (день недели + время + тип занятия). Учитель и комната могут быть на уровне офферинга или на уровне слота.
- Генерация всегда привязана к **одному семестру**: даты уроков лежат в границах выбранного семестра; при перегенерации удаляются и пересоздаются только уроки этого семестра.
- **После генерации** уроки появляются в модуле расписания; у каждого урока заполняется **offeringSlotId** (ссылка на слот). Уроки можно получить по **GET /api/schedule/lessons/offering/{offeringId}** или **GET /api/schedule/lessons?date=...**; по **offeringSlotId** на UI можно определить тип занятия (slot.lessonType) и преподавателя (slot или роль по типу).

---

## 3. Воркфлоу и последствия удаления компонентов

Цепочка данных: **Группа** (привязан учебный план curriculum) → **Предметы учебного плана** (curriculum subjects с durationWeeks) → **Офферинг** (группа + предмет плана) → **Слоты офферинга** (недельные слоты) → **Уроки** (создаются генерацией; хранят offeringId и offeringSlotId).

Ниже — что происходит при удалении каждого звена и как вести себя фронту.

### 3.1 Удаление группы

- Офферинги привязаны к группе (`groupId`). Удаление группы выполняется в модуле групп (DELETE /api/groups/{id}).
- **Поведение системы:** в зависимости от реализации при удалении группы могут каскадно удаляться или блокироваться офферинги этой группы; либо офферинги остаются с несуществующим groupId (сироты). Рекомендуется перед удалением группы убедиться, что офферингов по ней нет, или что контракт групп явно описывает каскад.
- **Для фронта:** перед удалением группы запросить GET /api/offerings/group/{groupId}. Если список не пуст, показать предупреждение и при необходимости сначала удалить офферинги (и тем самым связанные слоты и уроки).

### 3.2 Удаление предмета учебного плана (curriculum subject)

- Офферинг хранит **curriculumSubjectId**. При удалении предмета плана (DELETE /api/programs/curriculum-subjects/{id}) офферинги, ссылающиеся на этот предмет, не удаляются автоматически.
- **Поведение системы:** при следующей генерации уроков для такого офферинга сервер вернёт 404 (OFFERING_CURRICULUM_SUBJECT_NOT_FOUND). Уже сгенерированные уроки остаются в расписании (они привязаны к offeringId).
- **Для фронта:** при удалении предмета плана учитывать, что офферинги по этому предмету станут «битыми» для генерации. Имеет смысл предупреждать пользователя или заранее удалять/редактировать офферинги.

### 3.3 Удаление офферинга

- **Эндпоинт:** DELETE /api/offerings/{id}. **Роли:** MODERATOR, ADMIN, SUPER_ADMIN.
- **Поведение системы:** при удалении офферинга **в одном запросе** автоматически:
  1. Удаляются **все уроки** с этим offeringId (в модуле расписания).
  2. Удаляются **все слоты** этого офферинга.
  3. Удаляется сам офферинг.
- **Для фронта:** после успешного DELETE список офферингов группы и расписание по этой группе нужно обновить (уроков по этому офферингу больше нет).

### 3.4 Удаление слота офферинга

- **Эндпоинт:** DELETE /api/offerings/slots/{id}. **Роли:** MODERATOR, ADMIN, SUPER_ADMIN.
- **Поведение системы:** при удалении слота автоматически:
  1. Удаляются **все уроки**, сгенерированные по этому слоту (по полю offeringSlotId в уроке, а для старых уроков без offeringSlotId — по совпадению offeringId + день недели + время).
  2. Удаляется сам слот.
- **Для фронта:** после удаления слота обновить список слотов офферинга и расписание (уроков по этому слоту больше нет).

### 3.5 Удаление урока

- **Эндпоинт:** DELETE /api/schedule/lessons/{id}. **Роли:** MODERATOR, ADMIN, SUPER_ADMIN.
- **Поведение системы:** удаляется только эта запись урока. Офферинг и слоты не меняются.
- **Для фронта:** обновить отображение расписания на день/неделю.

### 3.6 Сводка: кто что удаляет

| Удаляемый объект | Что ещё удаляется автоматически |
|------------------|----------------------------------|
| Офферинг | Все слоты офферинга, все уроки по этому офферингу |
| Слот офферинга | Все уроки, сгенерированные по этому слоту |
| Урок | Ничего (только сам урок) |

---

## 4. Модели данных (модуль Offerings)

### 4.1 GroupSubjectOfferingDto

Офферинг — привязка «группа + предмет из учебного плана» с опциональными учителем, комнатой и заметками.

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Идентификатор офферинга |
| `groupId` | UUID | Id группы |
| `curriculumSubjectId` | UUID | Id предмета учебного плана (curriculum subject) |
| `teacherId` | UUID \| null | Id учителя (профиль учителя из account) |
| `roomId` | UUID \| null | Id комнаты (из schedule) |
| `format` | string \| null | Формат: `offline`, `online`, `mixed` (нормализуется к нижнему регистру) |
| `notes` | string \| null | Заметки |
| `createdAt` | string | Дата и время создания (ISO-8601) |
| `updatedAt` | string | Дата и время обновления (ISO-8601) |

### 4.2 OfferingSlotDto

Недельный слот офферинга: день недели, время, тип занятия, опционально комната и учитель. По слотам генерируются уроки (один слот → N уроков по числу недель durationWeeks).

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Идентификатор слота |
| `offeringId` | UUID | Id офферинга |
| `dayOfWeek` | integer | День недели (1–7, понедельник=1) |
| `startTime` | string | Время начала (HH:mm или HH:mm:ss) |
| `endTime` | string | Время окончания |
| `timeslotId` | UUID \| null | Id таймслота-шаблона (подсказка UI) |
| `lessonType` | string | Тип занятия: `LECTURE`, `PRACTICE`, `LAB`, `SEMINAR` |
| `roomId` | UUID \| null | Id комнаты |
| `teacherId` | UUID \| null | Id учителя (профиль) |
| `createdAt` | string | Дата и время создания (ISO-8601) |

### 4.3 OfferingTeacherItemDto

Элемент списка преподавателей офферинга (данные **выводятся** из основного преподавателя офферинга и преподавателей слотов; отдельная таблица не хранится).

| Поле | Тип | Описание |
|------|-----|----------|
| `teacherId` | UUID | Id преподавателя (профиль) |
| `role` | string \| null | Роль: `null` для основного преподавателя офферинга; `LECTURE`, `PRACTICE`, `LAB`, `SEMINAR` для преподавателя из слота (из типа занятия слота) |

---

## 5. Офферинги (CRUD)

### 5.1 GET /api/offerings/group/{groupId}

**Назначение:** получить все офферинги группы для экрана «Расписание группы» или выбора офферинга перед добавлением слотов и генерацией уроков.

**Метод и путь:** `GET /api/offerings/group/{groupId}`

**Роли:** любая аутентифицированная роль (JWT обязателен).

**Параметр пути:** `groupId` — UUID группы.

**Успешный ответ:** `200 OK` — массив объектов **GroupSubjectOfferingDto**. Порядок по curriculumSubjectId.

**Ошибки:** при несуществующей группе возможна пустая выборка или ошибка от зависимостей; при несуществующем id группы — по контракту групп см. контракт групп.

---

### 5.2 GET /api/offerings/{id}

**Назначение:** получить офферинг по id (например, для формы редактирования или перед добавлением слотов).

**Метод и путь:** `GET /api/offerings/{id}`

**Роли:** любая аутентифицированная роль.

**Параметр пути:** `id` — UUID офферинга.

**Успешный ответ:** `200 OK` — один объект **GroupSubjectOfferingDto**.

**Ошибки:** `404 Not Found` — офферинг не найден. Код в теле: `OFFERING_NOT_FOUND`, сообщение вида `"Offering not found"`.

---

### 5.3 POST /api/offerings

**Назначение:** создать офферинг «группа + предмет учебного плана». Это первый шаг перед добавлением слотов и генерацией уроков. В теле можно указать учителя и комнату по умолчанию.

**Метод и путь:** `POST /api/offerings`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Тело запроса:**

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `groupId` | UUID | обязательно | Id группы |
| `curriculumSubjectId` | UUID | обязательно | Id предмета учебного плана (из GET /api/programs/curricula/{curriculumId}/subjects) |
| `teacherId` | UUID | нет | Id учителя (профиль: из GET /api/account/teachers — подставлять `profile.id`) |
| `roomId` | UUID | нет | Id комнаты (из GET /api/schedule/rooms) |
| `format` | string | нет | `offline`, `online`, `mixed` |
| `notes` | string | нет | Заметки |

**Успешный ответ:** `201 Created` — объект **GroupSubjectOfferingDto**.

**Ошибки:**  
- `400 Bad Request` — не указаны groupId или curriculumSubjectId; группа, предмет, учитель или комната не найдены (NOT_FOUND).  
- `409 Conflict` — офферинг для этой пары группа+предмет уже существует.

---

### 5.4 PUT /api/offerings/{id}

**Назначение:** обновить учителя, комнату, формат и заметки офферинга.

**Метод и путь:** `PUT /api/offerings/{id}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:** `id` — UUID офферинга.

**Тело запроса:**

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `teacherId` | UUID \| null | нет | Id учителя или null |
| `roomId` | UUID \| null | нет | Id комнаты или null |
| `format` | string \| null | нет | offline / online / mixed |
| `notes` | string \| null | нет | Заметки |

**Успешный ответ:** `200 OK` — объект **GroupSubjectOfferingDto**.

**Ошибки:** `404 Not Found` — офферинг не найден; `400` — учитель или комната не найдены.

---

### 5.5 DELETE /api/offerings/{id}

**Назначение:** удалить офферинг. При удалении автоматически удаляются все слоты этого офферинга и **все уроки**, созданные по этому офферингу (в модуле расписания). Подробнее см. раздел 3.3.

**Метод и путь:** `DELETE /api/offerings/{id}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:** `id` — UUID офферинга.

**Успешный ответ:** `204 No Content`.

**Ошибки:** `404 Not Found` — офферинг не найден.

---

## 6. Учителя офферинга

Список преподавателей офферинга **выводится** из основного преподавателя офферинга (поле `teacherId` офферинга) и преподавателей, назначенных в слоты (поле `teacherId` каждого слота). Роль основного преподавателя — `null`; у преподавателей из слотов роль совпадает с типом занятия слота (LECTURE, PRACTICE, LAB, SEMINAR). Добавление и удаление преподавателей выполняется через назначение основного преподавателя офферинга (PUT офферинга) или преподавателя в слоте (POST/PUT слота).

### 6.1 GET /api/offerings/{offeringId}/teachers

**Назначение:** получить список преподавателей офферинга (для отображения на экране офферинга). Данные выводятся из основного преподавателя и слотов (только чтение).

**Метод и путь:** `GET /api/offerings/{offeringId}/teachers`

**Роли:** любая аутентифицированная роль.

**Параметр пути:** `offeringId` — UUID офферинга.

**Успешный ответ:** `200 OK` — массив объектов **OfferingTeacherItemDto** (поле `teacherId`, поле `role` — null для основного, иначе тип занятия слота).

**Ошибки:** `404 Not Found` — офферинг не найден.

---

## 7. Недельные слоты офферинга

Слот задаёт «когда в неделю» проходит занятие (день + время + тип). От числа слотов и durationWeeks предмета зависит количество сгенерированных уроков.

### 7.1 GET /api/offerings/{offeringId}/slots

**Назначение:** получить все слоты офферинга для отображения расписания по неделе и для формы «добавить/удалить слот».

**Метод и путь:** `GET /api/offerings/{offeringId}/slots`

**Роли:** любая аутентифицированная роль.

**Параметр пути:** `offeringId` — UUID офферинга.

**Успешный ответ:** `200 OK` — массив объектов **OfferingSlotDto**. Порядок: по дню недели, затем по времени начала.

**Ошибки:** при несуществующем offeringId — пустой массив или 404.

---

### 7.2 POST /api/offerings/{offeringId}/slots

**Назначение:** добавить недельный слот к офферингу. Либо задать слот через **таймслот** (timeslotId — день и время скопируются), либо явно указать день недели и время. Обязательно указать тип занятия (LECTURE, PRACTICE, LAB, SEMINAR). При удалении слота в дальнейшем автоматически удаляются все уроки, сгенерированные по этому слоту (подробнее см. раздел 3.4).

**Метод и путь:** `POST /api/offerings/{offeringId}/slots`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:** `offeringId` — UUID офферинга.

**Тело запроса:**

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `timeslotId` | UUID | нет* | Id таймслота (из GET /api/schedule/timeslots). Если задан, день и время берутся из таймслота; dayOfWeek/startTime/endTime можно не передавать. |
| `dayOfWeek` | integer | нет* | День недели 1–7 (понедельник=1). Обязателен, если не передан timeslotId. |
| `startTime` | string | нет* | Время начала "HH:mm" или "HH:mm:ss". Обязательно, если не передан timeslotId. |
| `endTime` | string | нет* | Время окончания. Обязательно, если не передан timeslotId. |
| `lessonType` | string | обязательно | Тип: `LECTURE`, `PRACTICE`, `LAB`, `SEMINAR` |
| `roomId` | UUID | нет | Id комнаты (из GET /api/schedule/rooms) |
| `teacherId` | UUID | нет | Id учителя (профиль из GET /api/account/teachers) |

\* Либо передаётся **timeslotId**, либо тройка **dayOfWeek**, **startTime**, **endTime**.

**Успешный ответ:** `201 Created` — объект **OfferingSlotDto**.

**Ошибки:**  
- `400 Bad Request` — не указан lessonType; не указаны ни timeslotId, ни (dayOfWeek, startTime, endTime); неверный формат времени; dayOfWeek не 1–7; endTime не после startTime; таймслот не найден.  
- `404 Not Found` — офферинг или (при указании) таймслот/учитель не найдены.  
- `409 Conflict` — слот с таким днём, временем и типом уже есть у офферинга.

---

### 7.3 DELETE /api/offerings/slots/{id}

**Назначение:** удалить слот офферинга. Все уроки, сгенерированные по этому слоту, удаляются автоматически (по offeringSlotId и по день+время для старых уроков). Подробнее см. раздел 3.4.

**Метод и путь:** `DELETE /api/offerings/slots/{id}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:** `id` — UUID слота (OfferingSlotDto.id).

**Успешный ответ:** `204 No Content`.

**Ошибки:** `404 Not Found` — слот не найден.

---

## 8. Генерация уроков

Все эндпоинты генерации требуют **обязательный query-параметр `semesterId`**. Уроки создаются **только для одного семестра**: даты уроков лежат строго в интервале [startDate, endDate] выбранного семестра.

### 8.1 POST /api/offerings/{offeringId}/generate-lessons

**Назначение:** создать уроки по одному офферингу **только на выбранный семестр**. Количество уроков = (число слотов офферинга) × durationWeeks предмета учебного плана (с обрезкой по датам семестра). У каждого урока — конкретная дата и время (по слотам и неделям в границах семестра); у урока заполняется **offeringSlotId** (для типа занятия и преподавателя на UI). Вызывать только после того, как у офферинга есть хотя бы один слот.

**Метод и путь:** `POST /api/offerings/{offeringId}/generate-lessons?semesterId={semesterId}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметры:**

| Параметр | Тип | Обязательность | Описание |
|----------|-----|----------------|----------|
| `offeringId` | UUID | да (path) | Id офферинга |
| `semesterId` | UUID | да (query) | Id семестра (из GET /api/academic/semesters/... или GET /api/academic/semesters/current). По нему определяются даты начала и конца семестра; уроки создаются только в этом диапазоне. |

**Успешный ответ:** `201 Created` — тело объект с полем `lessonsCreated` (integer): количество созданных уроков.

Пример тела: `{ "lessonsCreated": 24 }`

**Ошибки:**  
- `400 Bad Request` — у офферинга нет слотов (код `OFFERING_NO_SLOTS`).  
- `404 Not Found` — офферинг, семестр или предмет учебного плана не найдены (коды `OFFERING_NOT_FOUND`, `OFFERING_SEMESTER_NOT_FOUND`, `OFFERING_CURRICULUM_SUBJECT_NOT_FOUND`).  
- `409 Conflict` — уроки по этому офферингу уже существуют (код `OFFERING_LESSONS_ALREADY_EXIST`). В этом случае используйте **regenerate-lessons**.

---

### 8.2 POST /api/offerings/group/{groupId}/generate-lessons

**Назначение:** создать уроки по **всем** офферингам группы **только на выбранный семестр**. Для каждого офферинга группы, у которого есть хотя бы один слот и найден предмет учебного плана, генерируются уроки в диапазоне дат семестра. Офферинги без слотов или с отсутствующим предметом плана пропускаются. Удобно для массовой генерации «вся группа на один семестр».

**Метод и путь:** `POST /api/offerings/group/{groupId}/generate-lessons?semesterId={semesterId}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметры:**

| Параметр | Тип | Обязательность | Описание |
|----------|-----|----------------|----------|
| `groupId` | UUID | да (path) | Id группы |
| `semesterId` | UUID | да (query) | Id семестра. Уроки создаются только в границах дат этого семестра. |

**Успешный ответ:** `201 Created` — тело объект с полем `lessonsCreated` (integer): суммарное количество созданных уроков по всем офферингам группы.

**Ошибки:** `404 Not Found` — семестр не найден (`OFFERING_SEMESTER_NOT_FOUND`). Группа и офферинги не проверяются на существование в смысле 404; офферинги без слотов пропускаются.

---

### 8.3 POST /api/offerings/{offeringId}/regenerate-lessons

**Назначение:** удалить **только уроки выбранного семестра** по этому офферингу (по диапазону дат семестра) и заново сгенерировать уроки на этот семестр (по текущим слотам и durationWeeks). Уроки других семестров по тому же офферингу **не удаляются**. Используется, когда изменились слоты или нужно пересчитать уроки только для одного семестра.

**Метод и путь:** `POST /api/offerings/{offeringId}/regenerate-lessons?semesterId={semesterId}`

**Роли:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметры:**

| Параметр | Тип | Обязательность | Описание |
|----------|-----|----------------|----------|
| `offeringId` | UUID | да (path) | Id офферинга |
| `semesterId` | UUID | да (query) | Id семестра. Удаляются только уроки, чья дата попадает в [startDate, endDate] этого семестра; затем создаются новые уроки в том же диапазоне. |

**Успешный ответ:** `201 Created` — тело объект с полем `lessonsCreated` (integer).

**Ошибки:** те же, что у generate-lessons (в т.ч. OFFERING_NO_SLOTS, OFFERING_NOT_FOUND, OFFERING_SEMESTER_NOT_FOUND, OFFERING_CURRICULUM_SUBJECT_NOT_FOUND).

---

## 9. Эндпоинты других модулей для подстановки данных

Эти ручки нужны фронту для заполнения выпадающих списков и полей при работе с офферингами и генерации уроков. Роли для каждого эндпоинта см. в контрактах соответствующих модулей (groups, programs, account, schedule, academic).

### 9.1 Группы

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/groups` | Список всех групп (выбор группы при создании офферинга) |
| `GET /api/groups/{id}` | Группа по id (получить curriculumId для запроса предметов плана) |
| `GET /api/groups/program/{programId}` | Группы по программе |

В объекте группы есть `curriculumId` — по нему запрашивают предметы учебного плана.

---

### 9.2 Предметы учебного плана (curriculum subjects)

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/programs/curricula/{curriculumId}/subjects` | Список предметов учебного плана. Используется для выбора **curriculumSubjectId** при создании офферинга (POST /api/offerings). У каждого предмета есть **durationWeeks** — сколько недель идёт предмет (от этого числа и числа слотов зависит количество сгенерированных уроков). |
| `GET /api/programs/curriculum-subjects/{id}` | Предмет учебного плана по id |

**Структура элемента списка (CurriculumSubjectDto):** id, curriculumId, subjectId, semesterNo, courseYear, **durationWeeks**, hoursTotal, hoursLecture, hoursPractice, hoursLab, hoursSeminar, … (см. контракт программ).

---

### 9.3 Учителя

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/account/teachers` | Постраничный список учителей с отображаемым именем. Для полей **teacherId** в офферинге (POST/PUT /api/offerings), в слоте (POST /api/offerings/{id}/slots) и при добавлении учителя к офферингу (POST /api/offerings/{id}/teachers) подставлять **profile.id** из элемента списка. |
| `GET /api/account/teachers/{userId}` | Учитель по user id |

Query: `cursor`, `limit` (по умолчанию 30, макс. 30). Ответ: объект с `items` (массив TeacherProfileItem: profile — TeacherDto, displayName) и `nextCursor`.

---

### 9.4 Таймслоты (расписание)

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/schedule/timeslots` | Список всех таймслотов (шаблоны: день недели + время). Для добавления слота офферинга (POST /api/offerings/{offeringId}/slots) можно передать **timeslotId** — тогда день и время подставятся из таймслота. |
| `GET /api/schedule/timeslots/{id}` | Таймслот по id |

**Структура TimeslotDto:** id, dayOfWeek (1–7), startTime, endTime (LocalTime в JSON как строки времени).

---

### 9.5 Комнаты

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/schedule/rooms` | Список всех комнат. Для полей **roomId** при создании/обновлении офферинга и при добавлении слота. |
| `GET /api/schedule/rooms/{id}` | Комната по id |

**Структура RoomDto:** id, buildingId, buildingName, number, capacity, type, createdAt, updatedAt.

---

### 9.6 Учебный год и семестр (модуль Academic)

Эндпоинты для получения учебных годов и семестров. **semesterId** из ответа подставляется в query при генерации уроков (POST /api/offerings/{offeringId}/generate-lessons?semesterId=…). Даты семестра (startDate, endDate) задают границы дат сгенерированных уроков.

**Роли:** GET — любая аутентифицированная роль; создание/изменение/удаление — MODERATOR, ADMIN, SUPER_ADMIN (удаление года/семестра — только ADMIN, SUPER_ADMIN).

#### Модели данных (Academic)

**AcademicYearDto** — учебный год:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Идентификатор учебного года |
| `name` | string | Название (например, «2024/2025») |
| `startDate` | string | Дата начала (yyyy-MM-dd) |
| `endDate` | string | Дата окончания (yyyy-MM-dd) |
| `isCurrent` | boolean | Признак текущего учебного года |
| `createdAt` | string | Дата и время создания (ISO-8601) |

**SemesterDto** — семестр:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Идентификатор семестра (**semesterId** для генерации уроков) |
| `academicYearId` | UUID | Id учебного года |
| `number` | integer | Номер семестра (1, 2, …) |
| `name` | string \| null | Название семестра |
| `startDate` | string | Дата начала (yyyy-MM-dd) |
| `endDate` | string | Дата окончания (yyyy-MM-dd) |
| `examStartDate` | string \| null | Начало экзаменационной сессии |
| `examEndDate` | string \| null | Конец экзаменационной сессии |
| `weekCount` | integer \| null | Количество учебных недель (1–52) |
| `isCurrent` | boolean | Признак текущего семестра |
| `createdAt` | string | Дата и время создания (ISO-8601) |

#### Эндпоинты: получение данных по учебному году и семестру

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/academic/years` | Список всех учебных годов (для выбора года и перехода к семестрам). Ответ: массив **AcademicYearDto**. |
| `GET /api/academic/years/current` | Текущий учебный год. Ответ: один **AcademicYearDto** или `404 Not Found` (тела нет), если текущий год не задан. |
| `GET /api/academic/years/{id}` | Учебный год по id. Ответ: один **AcademicYearDto** или `404 Not Found`, если не найден. |
| `GET /api/academic/years/{academicYearId}/semesters` | Список семестров учебного года. Для выбора **semesterId** в UI генерации уроков. Ответ: массив **SemesterDto**. Параметр пути: `academicYearId` — UUID учебного года. |
| `GET /api/academic/semesters/current` | Текущий семестр (удобно подставить в **semesterId** при генерации уроков). Ответ: один **SemesterDto** или `404 Not Found`, если текущий семестр не задан. |
| `GET /api/academic/semesters/{id}` | Семестр по id. Ответ: один **SemesterDto** или `404 Not Found**. |

**Ошибки (при вызовах создания/обновления/удаления из этого модуля):** `400 Bad Request` — неверные даты (endDate раньше startDate, даты семестра вне границ года и т.п.), дубликат номера семестра в году; `404 Not Found` — учебный год или семестр не найден; `409 Conflict` — учебный год с таким именем уже существует или семестр с таким номером уже есть в этом году. Роли: при отсутствии прав — `403 Forbidden`, при невалидном JWT — `401 Unauthorized`.

#### Эндпоинты: создание и изменение (для настройки календаря)

| Метод и путь | Назначение |
|--------------|------------|
| `POST /api/academic/years` | Создать учебный год. Тело: `name` (обязательно), `startDate`, `endDate` (обязательно), `isCurrent` (опционально). Ответ: `201 Created` — **AcademicYearDto**. |
| `PUT /api/academic/years/{id}` | Обновить учебный год. Тело: `name`, `startDate`, `endDate`, `isCurrent` (все опционально). Ответ: `200 OK` — **AcademicYearDto**. |
| `DELETE /api/academic/years/{id}` | Удалить учебный год. Ответ: `204 No Content`. Роли: только ADMIN, SUPER_ADMIN. |
| `POST /api/academic/years/{academicYearId}/semesters` | Создать семестр в учебном году. Тело: `number` (обязательно, ≥ 1), `name`, `startDate`, `endDate` (обязательно), `examStartDate`, `examEndDate`, `weekCount` (1–52), `isCurrent`. Ответ: `201 Created` — **SemesterDto**. |
| `PUT /api/academic/semesters/{id}` | Обновить семестр. Тело: `name`, `startDate`, `endDate`, `examStartDate`, `examEndDate`, `weekCount`, `isCurrent` (все опционально). Ответ: `200 OK` — **SemesterDto**. |
| `DELETE /api/academic/semesters/{id}` | Удалить семестр. Ответ: `204 No Content`. Роли: только ADMIN, SUPER_ADMIN. |

В генерации уроков используются **startDate** и **endDate** семестра: даты созданных уроков лежат в этом диапазоне.

---

### 9.7 Уроки (после генерации)

| Метод и путь | Назначение |
|--------------|------------|
| `GET /api/schedule/lessons/offering/{offeringId}` | Список уроков по офферингу (по дате и времени). Для отображения расписания по офферингу после генерации. |
| `GET /api/schedule/lessons?date={date}` | Уроки на дату (для экрана «Расписание на день»). |
| `GET /api/schedule/lessons/{id}` | Урок по id |
| `PUT /api/schedule/lessons/{id}` | Обновить урок (время, комната, тема, статус) |
| `DELETE /api/schedule/lessons/{id}` | Удалить урок |

Формат даты в query: `yyyy-MM-dd`. Подробнее см. контракт расписания (api-schedule-timeslots-rooms-contract.md).

---

## 10. Сводная таблица ошибок (модуль Offerings)

| HTTP | code | Когда возникает |
|------|------|------------------|
| 400 | BAD_REQUEST | Не указаны обязательные поля; неверный формат времени/дня недели/формата/роли/типа занятия; endTime не после startTime; офферинг без слотов при генерации |
| 400 | OFFERING_NO_SLOTS | У офферинга нет слотов — нельзя генерировать уроки |
| 404 | NOT_FOUND | Общий «не найдено» (группа, учитель, комната, таймслот и т.д.) |
| 404 | OFFERING_NOT_FOUND | Офферинг не найден |
| 404 | OFFERING_SEMESTER_NOT_FOUND | Семестр не найден при генерации |
| 404 | OFFERING_CURRICULUM_SUBJECT_NOT_FOUND | Предмет учебного плана не найден при генерации |
| 404 | OFFERING_TIMESLOT_NOT_RESOLVED | Таймслот не найден при добавлении слота |
| 409 | CONFLICT | Офферинг для пары группа+предмет уже существует; слот с таким днём/временем/типом уже есть; учитель с такой ролью уже добавлен |
| 409 | OFFERING_LESSONS_ALREADY_EXIST | Уроки по офферингу уже есть — использовать regenerate-lessons |
| 401 | UNAUTHORIZED | Не передан или невалидный JWT |
| 403 | FORBIDDEN | Нет роли MODERATOR, ADMIN или SUPER_ADMIN для операции изменения |

---

## 11. Примеры запросов и ответов

### Создание офферинга

**Запрос:**  
`POST /api/offerings`  
`Content-Type: application/json`

```json
{
  "groupId": "550e8400-e29b-41d4-a716-446655440001",
  "curriculumSubjectId": "550e8400-e29b-41d4-a716-446655440002",
  "teacherId": "550e8400-e29b-41d4-a716-446655440003",
  "roomId": "550e8400-e29b-41d4-a716-446655440004",
  "format": "offline",
  "notes": null
}
```

**Ответ:** `201 Created`

```json
{
  "id": "660e8400-e29b-41d4-a716-446655440010",
  "groupId": "550e8400-e29b-41d4-a716-446655440001",
  "curriculumSubjectId": "550e8400-e29b-41d4-a716-446655440002",
  "teacherId": "550e8400-e29b-41d4-a716-446655440003",
  "roomId": "550e8400-e29b-41d4-a716-446655440004",
  "format": "offline",
  "notes": null,
  "createdAt": "2025-02-07T10:00:00",
  "updatedAt": "2025-02-07T10:00:00"
}
```

---

### Добавление слота (с таймслотом)

**Запрос:**  
`POST /api/offerings/660e8400-e29b-41d4-a716-446655440010/slots`  
`Content-Type: application/json`

```json
{
  "timeslotId": "770e8400-e29b-41d4-a716-446655440020",
  "lessonType": "LECTURE",
  "roomId": "550e8400-e29b-41d4-a716-446655440004",
  "teacherId": null
}
```

**Ответ:** `201 Created` — объект **OfferingSlotDto** с заполненными dayOfWeek, startTime, endTime из таймслота.

---

### Добавление слота (без таймслота)

**Запрос:**  
`POST /api/offerings/660e8400-e29b-41d4-a716-446655440010/slots`

```json
{
  "dayOfWeek": 1,
  "startTime": "09:00",
  "endTime": "10:30",
  "lessonType": "PRACTICE",
  "roomId": null,
  "teacherId": null
}
```

**Ответ:** `201 Created` — объект **OfferingSlotDto**.

---

### Генерация уроков (только для одного семестра)

**Запрос:**  
`POST /api/offerings/660e8400-e29b-41d4-a716-446655440010/generate-lessons?semesterId=880e8400-e29b-41d4-a716-446655440030`

**Ответ:** `201 Created`

```json
{
  "lessonsCreated": 24
}
```

(24 урока, например: 2 слота × 12 недель по учебному плану; даты — только в границах семестра с id 880e8400-….)

---

### Перегенерация уроков (только для выбранного семестра)

**Запрос:**  
`POST /api/offerings/660e8400-e29b-41d4-a716-446655440010/regenerate-lessons?semesterId=880e8400-e29b-41d4-a716-446655440030`

**Ответ:** `201 Created`

```json
{
  "lessonsCreated": 24
}
```

Удаляются только уроки офферинга, чья дата попадает в диапазон [startDate, endDate] указанного семестра; уроки других семестров сохраняются. Затем создаются новые уроки на этот семестр.

---

### Ошибка: нет слотов

**Запрос:** `POST /api/offerings/{offeringId}/generate-lessons?semesterId={semesterId}` для офферинга без слотов.

**Ответ:** `400 Bad Request`

```json
{
  "code": "OFFERING_NO_SLOTS",
  "message": "Offering has no weekly slots assigned",
  "timestamp": "2025-02-07T12:00:00.000Z",
  "details": null
}
```
