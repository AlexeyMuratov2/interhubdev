# Контракт API: здания, комнаты и таймслоты (Schedule)

Документ-контракт для фронтенда. Описывает эндпоинты модуля расписания, относящиеся **к зданиям (buildings), комнатам (rooms) и таймслотам (timeslots)**: справочник зданий, справочник аудиторий (привязанных к зданию), справочник слотов по дням недели и времени. Уроки (lessons) в этот контракт не входят.

---

## 1. Общие сведения

### 1.1 Базовый URL и префиксы

| Префикс | Назначение |
|---------|-------------|
| `/api` | Общий префикс REST API |
| `/api/schedule` | Расписание: здания, комнаты и таймслоты (в данном документе — только они) |

Хост и порт задаются окружением развёртывания. В описании ниже указаны только путь и query.

### 1.2 Авторизация

- Запросы выполняются с заголовком: **`Authorization: Bearer <JWT>`** (токен выдаётся при входе).
- Эндпоинты, которые **изменяют данные** (POST, PUT, DELETE) для зданий, комнат и таймслотов доступны только пользователям с одной из ролей: **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.
- Эндпоинты только для чтения (GET) в этом документе не помечены отдельной ролью; при необходимости уточните политику доступа в проекте.

### 1.3 Типы данных в ответах

- **UUID** — строка в формате UUID, например: `"550e8400-e29b-41d4-a716-446655440000"`.
- **Даты и время** — строки в формате **ISO-8601**: дата-время вида `"2025-02-05T12:00:00"`, время вида `"09:00:00"` или `"09:00"`.
- **Числа** — JSON number; для целых полей (день недели, вместимость) — целое число.
- **null** — явное отсутствие значения; поля могут не присутствовать в JSON или быть `null` в зависимости от контракта.

### 1.4 Формат ошибок

При любой ошибке (4xx, 5xx) сервер может возвращать JSON-объект **ErrorResponse**:

| Поле | Тип | Описание |
|------|-----|----------|
| `code` | string | Код ошибки (например, `BAD_REQUEST`, `NOT_FOUND`, `VALIDATION_FAILED`, `UNAUTHORIZED`, `FORBIDDEN`) |
| `message` | string | Человекочитаемое сообщение |
| `timestamp` | string | Момент возникновения ошибки (ISO-8601, UTC) |
| `details` | object \| null | Опционально. Для ошибок валидации — объект «имя поля → сообщение»; иначе может отсутствовать |

Пример ответа с ошибкой валидации (400):

```json
{
  "code": "VALIDATION_FAILED",
  "message": "Ошибка проверки данных. Проверьте заполненные поля.",
  "timestamp": "2025-02-06T12:00:00.123Z",
  "details": {
    "buildingId": "Building id is required",
    "capacity": "Capacity must be >= 0"
  }
}
```

Пример ответа «не найдено» (404):

```json
{
  "code": "NOT_FOUND",
  "message": "Room not found: 550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-02-06T12:00:00.123Z",
  "details": null
}
```

При ответе 404 от части эндпоинтов (например, GET по id) тело может быть пустым — в зависимости от реализации контроллера.

---

## 2. Здания (Buildings)

Справочник зданий (корпусов). Комнаты привязаны к зданию через `buildingId`. Перед созданием комнат нужно создать или выбрать здание.

### 2.1 Модель данных здания (BuildingDto)

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор здания |
| `name` | string | Название здания |
| `address` | string \| null | Адрес; опционально |
| `createdAt` | string | Дата и время создания записи (ISO-8601) |
| `updatedAt` | string | Дата и время последнего обновления (ISO-8601) |

### 2.2 GET /api/schedule/buildings

**Назначение:** список всех зданий (для выбора здания при создании комнаты).

**Метод и путь:** `GET /api/schedule/buildings`

**Успешный ответ:** `200 OK` — массив **BuildingDto**, упорядочен по `name`.

### 2.3 GET /api/schedule/buildings/{id}

**Назначение:** получение здания по id.

**Метод и путь:** `GET /api/schedule/buildings/{id}`

**Успешный ответ:** `200 OK` — объект **BuildingDto**. При отсутствии — **404 Not Found**.

### 2.4 POST /api/schedule/buildings

**Назначение:** создание здания. Права: MODERATOR, ADMIN, SUPER_ADMIN.

**Body:** `{ "name": "string (обязательно)", "address": "string | null" }`

**Успешный ответ:** `201 Created` — объект **BuildingDto**.

**Ошибки:** 400 (name пустое), 401, 403.

### 2.5 PUT /api/schedule/buildings/{id}

**Назначение:** обновление здания. Поля в body опциональны: `name`, `address`.

**Успешный ответ:** `200 OK` — объект **BuildingDto**. **Ошибки:** 404 (здание не найдено), 401, 403.

### 2.6 DELETE /api/schedule/buildings/{id}

**Назначение:** удаление здания. Права: MODERATOR, ADMIN, SUPER_ADMIN. Удаление возможно **только если у здания нет комнат**.

**Успешный ответ:** `204 No Content`. **Ошибки:** 404 (здание не найдено), **409 CONFLICT** («Building has rooms; delete or reassign rooms first»), 401, 403.

---

## 3. Комнаты (Rooms)

Справочник аудиторий: здание (buildingId), номер, вместимость, тип. Комната принадлежит одному зданию.

### 3.1 Модель данных комнаты (RoomDto)

Во всех успешных ответах, где возвращается комната или список комнат, используется объект **RoomDto**:

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор комнаты |
| `buildingId` | UUID | Идентификатор здания |
| `buildingName` | string | Название здания (для отображения) |
| `number` | string | Номер комнаты |
| `capacity` | integer \| null | Вместимость (число мест); может быть `null` |
| `type` | string \| null | Тип помещения (например, лекционная, лаборатория); опционально |
| `createdAt` | string | Дата и время создания записи (ISO-8601) |
| `updatedAt` | string | Дата и время последнего обновления (ISO-8601) |

---

### 3.2 GET /api/schedule/rooms

**Назначение:** получение списка всех комнат (для выпадающих списков, выбора аудитории при создании урока и т.п.).

**Метод и путь:** `GET /api/schedule/rooms`

**Права доступа:** ограничения по ролям для чтения в данном документе не определены.

**Параметры:** path и query отсутствуют.

**Успешный ответ:** `200 OK`

Тело ответа — массив объектов **RoomDto** (см. таблицу выше). Список упорядочен по названию здания (`buildingName`), затем по `number`.

**Ошибки:** при невалидном или отсутствующем JWT — `401 Unauthorized` (код `UNAUTHORIZED`); при недостатке прав — `403 Forbidden` (код `FORBIDDEN`), если на чтение применена политика.

---

### 3.3 GET /api/schedule/rooms/{id}

**Назначение:** получение одной комнаты по идентификатору.

**Метод и путь:** `GET /api/schedule/rooms/{id}`

**Права доступа:** без отдельного ограничения по ролям для чтения.

**Параметры:**

| Место | Параметр | Тип | Описание |
|-------|----------|-----|----------|
| path | `id` | UUID | Идентификатор комнаты |

**Успешный ответ:** `200 OK`

Тело ответа — объект **RoomDto**.

**Ошибки:** при отсутствии комнаты с указанным `id` — **404 Not Found**. Тело ответа может быть пустым или в формате ErrorResponse с кодом `NOT_FOUND` и сообщением вида «Room not found: &lt;id&gt;».

---

### 3.4 POST /api/schedule/rooms

**Назначение:** создание новой комнаты.

**Метод и путь:** `POST /api/schedule/rooms`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Body запроса:**

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `buildingId` | UUID | да | Идентификатор здания (существующего) |
| `number` | string | да | Номер комнаты; не пустая строка |
| `capacity` | integer | нет | Вместимость; если передано — ≥ 0 |
| `type` | string | нет | Тип помещения |

**Успешный ответ:** `201 Created`

Тело ответа — созданный объект **RoomDto**.

**Ошибки:**

- **400 Bad Request** — не пройдена валидация: пустой `buildingId` или `number`, `capacity` < 0. Код в теле: `BAD_REQUEST` или `VALIDATION_FAILED`; в `details` — объект «поле → сообщение».
- **404 Not Found** — здание с указанным `buildingId` не найдено; код `NOT_FOUND`.
- **401 Unauthorized** — код `UNAUTHORIZED`.
- **403 Forbidden** — код `FORBIDDEN`.

---

### 3.5 POST /api/schedule/rooms/bulk

**Назначение:** массовое создание комнат в одной транзакции. При ошибке валидации или отсутствии здания для любого элемента вся пачка откатывается.

**Метод и путь:** `POST /api/schedule/rooms/bulk`

**Права доступа:** MODERATOR, ADMIN, SUPER_ADMIN.

**Body запроса:** массив объектов того же формата, что и для создания одной комнаты:

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `buildingId` | UUID | да | Идентификатор здания |
| `number` | string | да | Номер комнаты |
| `capacity` | integer | нет | Вместимость; если передано — ≥ 0 |
| `type` | string | нет | Тип помещения |

**Успешный ответ:** `201 Created` — массив созданных **RoomDto** в том же порядке, что и элементы запроса. Пустой массив в теле запроса допустим; в ответе будет пустой массив.

**Ошибки:** те же, что и для POST /api/schedule/rooms (400, 404 по buildingId, 401, 403).

---

### 3.6 PUT /api/schedule/rooms/{id}

**Назначение:** обновление существующей комнаты.

**Метод и путь:** `PUT /api/schedule/rooms/{id}`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Параметры:**

| Место | Параметр | Тип | Описание |
|-------|----------|-----|----------|
| path | `id` | UUID | Идентификатор комнаты |

**Body запроса:** все поля опциональны; передаются только те, которые нужно изменить.

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `buildingId` | UUID | нет | Идентификатор здания (при смене здания) |
| `number` | string | нет | Номер комнаты |
| `capacity` | integer | нет | Вместимость; если передано — должно быть ≥ 0 |
| `type` | string | нет | Тип помещения |

**Успешный ответ:** `200 OK`

Тело ответа — обновлённый объект **RoomDto**.

**Ошибки:**

- **400 Bad Request** — например, переданное `capacity` < 0. Код `BAD_REQUEST` или `VALIDATION_FAILED`; при валидации полей — `details` с сообщениями по полям.
- **404 Not Found** — комната или здание (если передан `buildingId`) не найдены; код `NOT_FOUND`.
- **401 Unauthorized** — код `UNAUTHORIZED`.
- **403 Forbidden** — код `FORBIDDEN`.

---

### 3.7 DELETE /api/schedule/rooms/{id}

**Назначение:** удаление комнаты по идентификатору.

**Метод и путь:** `DELETE /api/schedule/rooms/{id}`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Параметры:**

| Место | Параметр | Тип | Описание |
|-------|----------|-----|----------|
| path | `id` | UUID | Идентификатор комнаты |

**Успешный ответ:** `204 No Content`

Тело ответа отсутствует.

**Ошибки:**

- **404 Not Found** — комната с указанным `id` не найдена; код `NOT_FOUND`, сообщение вида «Room not found: &lt;id&gt;».
- **401 Unauthorized** — код `UNAUTHORIZED`.
- **403 Forbidden** — код `FORBIDDEN`.

---

## 4. Таймслоты (Timeslots)

Справочник **шаблонов времени** (день недели + время начала и окончания). Используется в UI как подсказка при выборе времени урока или слота офферинга: пользователь выбирает слот, время подставляется в сущность (урок/слот офферинга владеет своим временем). Удаление таймслота не затрагивает уже созданные уроки.

### 4.1 Модель данных таймслота (TimeslotDto)

| Поле | Тип | Описание |
|------|-----|----------|
| `id` | UUID | Уникальный идентификатор таймслота |
| `dayOfWeek` | integer | День недели: 1 = понедельник, 7 = воскресенье |
| `startTime` | string | Время начала (ISO-8601 local time, например `"09:00:00"` или `"09:00"`) |
| `endTime` | string | Время окончания (ISO-8601 local time) |

---

### 4.2 GET /api/schedule/timeslots

**Назначение:** получение списка всех таймслотов (шаблонов времени) для выбора в UI при создании урока или слота офферинга.

**Метод и путь:** `GET /api/schedule/timeslots`

**Права доступа:** без отдельного ограничения по ролям для чтения.

**Параметры:** path и query отсутствуют.

**Успешный ответ:** `200 OK` — массив объектов **TimeslotDto**, упорядочен по `dayOfWeek`, затем по `startTime`.

**Ошибки:** при невалидном или отсутствующем JWT — `401 Unauthorized`; при применении политики на чтение — `403 Forbidden`.

---

### 4.3 GET /api/schedule/timeslots/{id}

**Назначение:** получение одного таймслота по идентификатору.

**Метод и путь:** `GET /api/schedule/timeslots/{id}`

**Права доступа:** без отдельного ограничения по ролям для чтения.

**Параметры:**

| Место | Параметр | Тип | Описание |
|-------|----------|-----|----------|
| path | `id` | UUID | Идентификатор таймслота |

**Успешный ответ:** `200 OK`

Тело ответа — объект **TimeslotDto**.

**Ошибки:** при отсутствии таймслота с указанным `id` — **404 Not Found**. Тело ответа может быть пустым или в формате ErrorResponse с кодом `NOT_FOUND` и сообщением вида «Timeslot not found: &lt;id&gt;».

---

### 4.4 POST /api/schedule/timeslots

**Назначение:** создание нового таймслота (шаблона времени для UI).

**Метод и путь:** `POST /api/schedule/timeslots`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Body запроса:**

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `dayOfWeek` | integer | да | День недели: 1–7 (1 = понедельник, 7 = воскресенье) |
| `startTime` | string | да | Время начала в формате **HH:mm** или **HH:mm:ss** (например, `"09:00"`, `"09:00:00"`) |
| `endTime` | string | да | Время окончания в том же формате; должно быть **строго после** `startTime` |

**Успешный ответ:** `201 Created`

Тело ответа — созданный объект **TimeslotDto**.

**Ошибки:**

- **400 Bad Request** — не пройдена валидация: `dayOfWeek` не в диапазоне 1–7; пустые `startTime` или `endTime`; неверный формат времени; `endTime` не после `startTime`. Код в теле: `BAD_REQUEST` или `VALIDATION_FAILED`. Примеры сообщений: «dayOfWeek must be 1..7», «startTime is required», «Invalid startTime format, use HH:mm or HH:mm:ss», «endTime must be after startTime». При Bean Validation в `details` — объект «поле → сообщение».
- **401 Unauthorized** — код `UNAUTHORIZED`.
- **403 Forbidden** — код `FORBIDDEN`.

---

### 4.5 POST /api/schedule/timeslots/bulk

**Назначение:** массовое создание таймслотов в одной транзакции. При ошибке валидации для любого элемента вся пачка откатывается.

**Метод и путь:** `POST /api/schedule/timeslots/bulk`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Body запроса:** массив объектов того же формата, что и для создания одного таймслота:

| Поле | Тип | Обязательность | Описание |
|------|-----|----------------|----------|
| `dayOfWeek` | integer | да | День недели: 1–7 |
| `startTime` | string | да | Время начала (HH:mm или HH:mm:ss) |
| `endTime` | string | да | Время окончания; должно быть строго после startTime |

**Успешный ответ:** `201 Created` — массив созданных **TimeslotDto** в том же порядке, что и элементы запроса. Пустой массив в теле запроса допустим; в ответе будет пустой массив.

**Ошибки:** те же, что и для POST /api/schedule/timeslots (400 при валидации, 401, 403).

---

### 4.6 DELETE /api/schedule/timeslots/{id}

**Назначение:** удаление таймслота по идентификатору.

**Метод и путь:** `DELETE /api/schedule/timeslots/{id}`

**Права доступа:** только **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.

**Параметры:**

| Место | Параметр | Тип | Описание |
|-------|----------|-----|----------|
| path | `id` | UUID | Идентификатор таймслота |

**Успешный ответ:** `204 No Content`

Тело ответа отсутствует.

**Ошибки:**

- **404 Not Found** — таймслот с указанным `id` не найден; код `NOT_FOUND`, сообщение вида «Timeslot not found: &lt;id&gt;».
- **401 Unauthorized** — код `UNAUTHORIZED`.
- **403 Forbidden** — код `FORBIDDEN`.

**Примечание:** обновление таймслота (PUT) в API не предусмотрено; при необходимости изменить слот — удалить и создать новый. Удаление таймслота не удаляет уроки: у уроков хранится своё время (startTime, endTime), а timeslotId на уроке опционален (подсказка для UI).

---

## 5. Сводная таблица ошибок

| HTTP | code | Когда возникает |
|------|------|------------------|
| 400 | BAD_REQUEST | Неверные данные: пустые name/buildingId/number, capacity < 0, dayOfWeek не 1..7, endTime не после startTime, неверный формат времени. |
| 400 | VALIDATION_FAILED | Ошибки Bean Validation (пустые/некорректные поля); в `details` — объект «поле → сообщение». |
| 401 | UNAUTHORIZED | Отсутствует или невалиден JWT. |
| 403 | FORBIDDEN | Нет роли MODERATOR/ADMIN/SUPER_ADMIN при вызове POST/PUT/DELETE. |
| 404 | NOT_FOUND | Здание, комната или таймслот с указанным id не найден (GET по id, PUT, DELETE; при создании комнаты — buildingId не найден). |
| 409 | CONFLICT | Удаление здания при наличии у него комнат («Building has rooms; delete or reassign rooms first»). |

---

## 6. Примеры запросов и ответов

### 6.1 Список зданий

**Запрос:** `GET /api/schedule/buildings`

**Ответ:** `200 OK`

```json
[
  {
    "id": "a0b1c2d3-e4f5-6789-0abc-def111111111",
    "name": "Корпус A",
    "address": "ул. Примерная, 1",
    "createdAt": "2025-01-15T10:00:00",
    "updatedAt": "2025-01-15T10:00:00"
  }
]
```

### 6.2 Список комнат

**Запрос:** `GET /api/schedule/rooms`

**Ответ:** `200 OK`

```json
[
  {
    "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "buildingId": "a0b1c2d3-e4f5-6789-0abc-def111111111",
    "buildingName": "Корпус A",
    "number": "101",
    "capacity": 30,
    "type": "лекционная",
    "createdAt": "2025-01-15T10:00:00",
    "updatedAt": "2025-01-15T10:00:00"
  },
  {
    "id": "b2c3d4e5-f6a7-8901-bcde-f12345678901",
    "buildingId": "a0b1c2d3-e4f5-6789-0abc-def111111111",
    "buildingName": "Корпус A",
    "number": "102",
    "capacity": 25,
    "type": null,
    "createdAt": "2025-01-15T10:05:00",
    "updatedAt": "2025-01-15T10:05:00"
  }
]
```

---

### 5.2 Создание комнаты

**Запрос:** `POST /api/schedule/rooms`

```json
{
  "building": "Корпус B",
  "number": "201",
  "capacity": 40,
  "type": "лаборатория"
}
```

**Ответ:** `201 Created`

```json
{
  "id": "c3d4e5f6-a7b8-9012-cdef-123456789012",
  "building": "Корпус B",
  "number": "201",
  "capacity": 40,
  "type": "лаборатория",
  "createdAt": "2025-02-06T12:00:00",
  "updatedAt": "2025-02-06T12:00:00"
}
```

---

### 6.4 Список таймслотов

**Запрос:** `GET /api/schedule/timeslots`

**Ответ:** `200 OK`

```json
[
  {
    "id": "d4e5f6a7-b8c9-0123-def0-234567890123",
    "dayOfWeek": 1,
    "startTime": "09:00:00",
    "endTime": "10:30:00"
  },
  {
    "id": "e5f6a7b8-c9d0-1234-ef01-345678901234",
    "dayOfWeek": 1,
    "startTime": "10:45:00",
    "endTime": "12:15:00"
  }
]
```

---

### 5.4 Создание таймслота

**Запрос:** `POST /api/schedule/timeslots`

```json
{
  "dayOfWeek": 3,
  "startTime": "14:00",
  "endTime": "15:30"
}
```

**Ответ:** `201 Created`

```json
{
  "id": "f6a7b8c9-d0e1-2345-f012-456789012345",
  "dayOfWeek": 3,
  "startTime": "14:00:00",
  "endTime": "15:30:00"
}
```

---

### 6.6 Ошибка валидации при создании таймслота

**Запрос:** `POST /api/schedule/timeslots`

```json
{
  "dayOfWeek": 8,
  "startTime": "15:00",
  "endTime": "14:00"
}
```

**Ответ:** `400 Bad Request`

```json
{
  "code": "BAD_REQUEST",
  "message": "dayOfWeek must be 1..7",
  "timestamp": "2025-02-06T12:00:00.123Z",
  "details": null
}
```

Или при `endTime` ≤ `startTime`:

```json
{
  "code": "BAD_REQUEST",
  "message": "endTime must be after startTime",
  "timestamp": "2025-02-06T12:00:00.123Z",
  "details": null
}
```

---

### 6.7 Комната не найдена

**Запрос:** `GET /api/schedule/rooms/550e8400-e29b-41d4-a716-446655440000`

**Ответ:** `404 Not Found` (тело может быть пустым или в формате ниже)

```json
{
  "code": "NOT_FOUND",
  "message": "Room not found: 550e8400-e29b-41d4-a716-446655440000",
  "timestamp": "2025-02-06T12:00:00.123Z",
  "details": null
}
```
