# Контракт API: обновление пользователя администратором

Документ описывает сценарий редактирования пользователя администратором (MODERATOR, ADMIN, SUPER_ADMIN): получение данных пользователя с профилями, обновление профиля и ролей, а также **поведение при добавлении пользователю новой роли** (в первую очередь STUDENT или TEACHER). По документу фронтенд может реализовать интеграцию без обращения к коду бэкенда.

Соглашения по базовому URL, авторизации, формату ошибок и типам данных совпадают с [Контрактом API: студенческие группы и учителя](api-groups-contract.md) (разделы 1.1–1.3). Ниже повторены только необходимые моменты и приведены эндпоинты и структуры, специфичные для обновления пользователя.

---

## 1. Назначение и сценарий

- Администратор открывает карточку пользователя (по UUID), меняет профиль (имя, фамилия, телефон, дата рождения) и/или набор ролей и сохраняет изменения.
- **Важный подслучай:** когда пользователю **добавляется роль** (например, STUDENT или TEACHER), в запрос нужно передать **полный новый набор ролей** (включая новую). Чтобы при этом сразу создать профиль студента или преподавателя, в тот же запрос включают объект **`studentProfile`** или **`teacherProfile`** с обязательными полями; иначе профиль не создаётся и его можно добавить позже. После успешного ответа фронтенд должен повторно запросить пользователя с профилями (`GET /api/account/users/{id}`), чтобы отобразить обновлённые и только что созданные профили.

---

## 2. Базовые соглашения

- **Префикс:** `/api/account`
- **Авторизация:** заголовок `Authorization: Bearer <JWT>`. Эндпоинты ниже доступны только пользователям с одной из ролей: **MODERATOR**, **ADMIN**, **SUPER_ADMIN**.
- **Формат ошибок:** при ошибке сервер возвращает JSON **ErrorResponse** (`code`, `message`, `timestamp`, опционально `details`) — см. [api-groups-contract.md](api-groups-contract.md), раздел 1.3.
- **Типы данных:** UUID — строка в формате UUID; даты и время — строки ISO-8601 (дата: `"2025-02-05"`, дата-время: `"2025-02-05T12:00:00"`).

---

## 3. Эндпоинты и структуры данных

### 3.1 GET /api/account/users/{id} — пользователь с профилями

**Назначение:** получение пользователя по ID вместе с опциональными профилями учителя и студента. Используется при открытии формы редактирования и **после сохранения** (чтобы отобразить обновлённые и только что созданные профили).

**Метод и путь:** `GET /api/account/users/{id}`

**Права:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:**

| Параметр | Тип  | Описание        |
|----------|------|-----------------|
| `id`     | UUID | ID пользователя |

**Ответ:** `200 OK`

Тело — объект **UserWithProfilesDto**:

| Поле             | Тип              | Описание                                                                 |
|------------------|------------------|--------------------------------------------------------------------------|
| `user`           | object           | **UserDto** — основные данные пользователя                               |
| `teacherProfile` | object \| null   | **TeacherDto**, если у пользователя есть роль TEACHER и создан профиль   |
| `studentProfile` | object \| null   | **StudentDto**, если у пользователя есть роль STUDENT и создан профиль   |

**UserDto:**

| Поле          | Тип              | Описание                                      |
|---------------|------------------|-----------------------------------------------|
| `id`          | UUID             | Идентификатор пользователя                    |
| `email`       | string           | Email (при обновлении через PATCH не меняется)|
| `roles`       | string[]         | Массив ролей: `SUPER_ADMIN`, `ADMIN`, `MODERATOR`, `STAFF`, `TEACHER`, `STUDENT` |
| `status`      | string           | `PENDING` \| `ACTIVE` \| `DISABLED`           |
| `firstName`   | string \| null   | Имя                                           |
| `lastName`    | string \| null   | Фамилия                                       |
| `phone`       | string \| null   | Телефон                                       |
| `birthDate`   | string \| null   | Дата рождения (ISO-8601, только дата)         |
| `createdAt`   | string           | Дата создания (ISO-8601)                      |
| `activatedAt` | string \| null   | Дата активации (ISO-8601)                     |
| `lastLoginAt` | string \| null   | Дата последнего входа (ISO-8601)              |

**TeacherDto** (если `teacherProfile` не null):

| Поле          | Тип              | Описание                |
|---------------|------------------|-------------------------|
| `id`          | UUID             | ID профиля учителя      |
| `userId`      | UUID             | ID пользователя         |
| `teacherId`   | string \| null   | Внешний идентификатор   |
| `faculty`     | string \| null   | Факультет               |
| `englishName` | string \| null   | Имя на английском       |
| `position`    | string \| null   | Должность               |
| `createdAt`   | string           | ISO-8601                |
| `updatedAt`   | string           | ISO-8601                |

**StudentDto** (если `studentProfile` не null):

| Поле           | Тип              | Описание                       |
|----------------|------------------|--------------------------------|
| `id`           | UUID             | ID профиля студента            |
| `userId`       | UUID             | ID пользователя                |
| `studentId`    | string \| null   | Внешний идентификатор студента |
| `chineseName`  | string \| null   | Китайское имя                  |
| `faculty`      | string \| null   | Факультет                      |
| `course`       | string \| null   | Курс/направление               |
| `enrollmentYear` | number \| null | Год поступления                |
| `groupName`    | string \| null   | Группа                         |
| `groupId`      | UUID \| null     | ID группы (если привязан)      |
| `createdAt`    | string           | ISO-8601                       |
| `updatedAt`    | string           | ISO-8601                       |

**Важно:** профиль студента или преподавателя появляется только после того, как он был создан — через тот же PATCH с полями `studentProfile`/`teacherProfile` при добавлении роли или через отдельные эндпоинты. Бэкенд **не** создаёт профили с заглушками при одном лишь добавлении роли.

---

### 3.2 PATCH /api/account/users/{id} — обновление пользователя

**Назначение:** обновление профиля (имя, фамилия, телефон, дата рождения), набора ролей и/или данных профилей студента и преподавателя. Email не меняется.

**Метод и путь:** `PATCH /api/account/users/{id}`

**Права:** MODERATOR, ADMIN, SUPER_ADMIN.

**Параметр пути:**

| Параметр | Тип  | Описание        |
|----------|------|-----------------|
| `id`     | UUID | ID пользователя |

**Тело запроса:** JSON-объект **UpdateUserRequest**. Все поля опциональны (PATCH-семантика).

| Поле            | Тип              | Описание                                                                 |
|-----------------|------------------|---------------------------------------------------------------------------|
| `firstName`     | string \| null    | Имя                                                                       |
| `lastName`      | string \| null    | Фамилия                                                                   |
| `phone`         | string \| null    | Телефон                                                                   |
| `birthDate`     | string \| null    | Дата рождения (ISO-8601, только дата)                                     |
| `roles`         | string[]         | **Полный новый набор ролей** пользователя                                  |
| `studentProfile`| object \| null   | Данные профиля студента (см. ниже). Передавать только при роли STUDENT.   |
| `teacherProfile`| object \| null   | Данные профиля преподавателя (см. ниже). Передавать только при роли TEACHER. |

**Структура `studentProfile`** (все поля опциональны для обновления; при **создании** нового профиля обязательны `studentId` и `faculty`):

| Поле           | Тип              | Описание                         |
|----------------|------------------|----------------------------------|
| `studentId`    | string           | Номер студента в системе вуза    |
| `chineseName`  | string \| null   | Китайское имя                    |
| `faculty`      | string           | Факультет                        |
| `course`       | string \| null   | Курс/направление                 |
| `enrollmentYear` | number \| null | Год поступления                  |
| `groupName`    | string \| null   | Группа                           |

**Структура `teacherProfile`** (все поля опциональны для обновления; при **создании** нового профиля обязательны `teacherId` и `faculty`):

| Поле         | Тип              | Описание                          |
|--------------|------------------|-----------------------------------|
| `teacherId`  | string           | Номер преподавателя в системе вуза  |
| `faculty`    | string           | Факультет                         |
| `englishName` | string \| null   | Имя на английском                 |
| `position`   | string \| null   | Должность                         |

**Ограничения по ролям:**

- В `roles` должна быть **хотя бы одна роль**.
- У пользователя допускается **не более одной** «админской» роли: только одна из `STAFF`, `MODERATOR`, `ADMIN`, `SUPER_ADMIN`.
- Роли `TEACHER` и `STUDENT` можно комбинировать друг с другом и с одной админской ролью.

**Валидация профилей:**

- Если передан `studentProfile`, у пользователя после применения `roles` должна быть роль **STUDENT**. Иначе ответ `400` с кодом `ACCOUNT_STUDENT_PROFILE_REQUIRES_ROLE`.
- Если передан `teacherProfile`, у пользователя после применения `roles` должна быть роль **TEACHER**. Иначе ответ `400` с кодом `ACCOUNT_TEACHER_PROFILE_REQUIRES_ROLE`.
- При **создании** нового профиля студента (профиля ещё нет) в `studentProfile` обязательны непустые `studentId` и `faculty`. Иначе `400` с кодом `ACCOUNT_STUDENT_PROFILE_CREATE_REQUIRED_FIELDS`.
- При **создании** нового профиля преподавателя в `teacherProfile` обязательны непустые `teacherId` и `faculty`. Иначе `400` с кодом `ACCOUNT_TEACHER_PROFILE_CREATE_REQUIRED_FIELDS`.

**Ответ:** `200 OK`

Тело — объект **UserDto** (обновлённый пользователь; **без** полей `teacherProfile` и `studentProfile`). Чтобы получить актуальные профили после сохранения, нужно выполнить отдельный запрос `GET /api/account/users/{id}` (см. раздел 4).

Пример тела запроса (добавление роли STUDENT и создание профиля студента в одном запросе):

```json
{
  "firstName": "Иван",
  "lastName": "Петров",
  "roles": ["SUPER_ADMIN", "STUDENT"],
  "studentProfile": {
    "studentId": "12345",
    "faculty": "Факультет информатики"
  }
}
```

Пример (только роли, без данных профиля — профиль студента/преподавателя не создаётся):

```json
{
  "roles": ["STUDENT"]
}
```

После такого запроса у пользователя будет роль STUDENT, но запись в таблице профилей студентов не появится; её можно создать позже тем же PATCH с `studentProfile` или через эндпоинт «Мой профиль студента».

---

## 4. Поведение при добавлении новой роли

### 4.1 Правило: в запрос передаётся полный новый набор ролей

- При любом изменении ролей фронтенд отправляет в `PATCH /api/account/users/{id}` поле **`roles`** — массив **всех** ролей, которые должны быть у пользователя после сохранения.
- Если администратор **добавляет** роль (например, STUDENT или TEACHER), в этот массив нужно **включить и новую роль**: взять текущий список ролей из `user.roles` и добавить новую роль, затем отправить получившийся массив в `roles`.
- **Пример:** у пользователя были роли `["SUPER_ADMIN"]`, администратор добавляет STUDENT. В запрос должно уйти `"roles": ["SUPER_ADMIN", "STUDENT"]`. Нельзя отправлять только `["STUDENT"]` — иначе роль SUPER_ADMIN будет сброшена.

### 4.2 Профили студента и преподавателя при добавлении роли

- Бэкенд **не** создаёт профиль студента или преподавателя автоматически при одном лишь добавлении роли. Если в запросе переданы только `roles` (без `studentProfile` или `teacherProfile`), профиль не создаётся.
- Чтобы при добавлении роли STUDENT или TEACHER сразу создать профиль, в тот же запрос нужно включить объект **`studentProfile`** или **`teacherProfile`** с обязательными полями (при создании: `studentId` и `faculty` для студента, `teacherId` и `faculty` для преподавателя).
- Если передан `studentProfile` или `teacherProfile`, у пользователя после применения `roles` должна быть соответствующая роль (STUDENT или TEACHER), иначе ответ `400` (см. валидацию выше).
- При **обновлении** уже существующего профиля в `studentProfile`/`teacherProfile` можно передавать только изменяемые поля (остальные не трогаются).

### 4.3 Действия фронтенда после сохранения

1. Ответ на `PATCH /api/account/users/{id}` содержит только **UserDto** (без `teacherProfile` и `studentProfile`).
2. Чтобы отобразить обновлённые профили (в том числе только что созданные), фронтенд должен **повторно вызвать** `GET /api/account/users/{id}` и подставить в UI данные из ответа **UserWithProfilesDto** (`user`, `teacherProfile`, `studentProfile`).
3. Если была добавлена роль STUDENT или TEACHER и в PATCH был передан соответствующий профиль, в ответе GET появятся объекты `studentProfile` или `teacherProfile` с переданными данными. Если профиль в PATCH не передавался, после добавления роли эти поля в GET останутся `null` до создания профиля (тем же PATCH с профилем или через отдельные эндпоинты).

---

## 5. Пошаговый сценарий для фронтенда

1. **Загрузка формы:** вызвать `GET /api/account/users/{id}`. Отобразить `user` (включая `user.roles`), `teacherProfile`, `studentProfile`. Для ролей использовать чекбоксы или теги по значениям из `user.roles`.
2. **Изменение данных:** пользователь меняет имя, фамилию, телефон, дату рождения и/или набор ролей (в том числе ставит галочку STUDENT или TEACHER).
3. **Сохранение:** сформировать тело запроса PATCH:
   - если менялись имя, фамилия, телефон или дата рождения — передать их в полях `firstName`, `lastName`, `phone`, `birthDate`;
   - если менялись роли — передать **полный новый массив ролей** в поле `roles` (включая только что добавленные);
   - если добавляется роль STUDENT или TEACHER и нужно сразу создать профиль — передать объект `studentProfile` или `teacherProfile` с обязательными полями (`studentId`, `faculty` или `teacherId`, `faculty`).
4. Отправить `PATCH /api/account/users/{id}` с этим телом.
5. После успешного ответа вызвать `GET /api/account/users/{id}` и обновить состояние формы/страницы данными из ответа (в том числе новые или обновлённые `teacherProfile` и `studentProfile`).

Документ самодостаточен: по нему можно реализовать сценарий обновления пользователя администратором и корректно обработать добавление новой роли (включая появление новой сущности профиля в ответе GET после сохранения).
